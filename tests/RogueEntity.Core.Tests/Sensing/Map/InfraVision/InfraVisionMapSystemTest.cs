using System;
using NUnit.Framework;
using RogueEntity.Core.Infrastructure.Time;
using RogueEntity.Core.Meta.Items;
using RogueEntity.Core.Meta.ItemTraits;
using RogueEntity.Core.Sensing;
using RogueEntity.Core.Sensing.Common.Blitter;
using RogueEntity.Core.Sensing.Common.Physics;
using RogueEntity.Core.Sensing.Map;
using RogueEntity.Core.Sensing.Map.InfraVision;
using RogueEntity.Core.Sensing.Receptors.InfraVision;
using RogueEntity.Core.Sensing.Resistance;
using RogueEntity.Core.Sensing.Sources.Heat;
using RogueEntity.Core.Utils;
using RogueEntity.Core.Utils.Algorithms;

namespace RogueEntity.Core.Tests.Sensing.Map.InfraVision
{
    public class InfraVisionMapSystemTest : SenseMapSystemTestBase<VisionSense, TemperatureSense, HeatSourceDefinition>
    {
        const string EmptyRoom = @"
// 11x11; an empty room
1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1
1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1 
1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1 
1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1 
1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1 
1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1 
1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1 
1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1 
1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1 
1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1 
1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1 
1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1 
1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1 
1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1 
1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1 
1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1 
1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1 
1, 0, 0, 0, 0, 0, 0, 0, 1 
1, 0, 0, 0, 0, 0, 0, 0, 1 
1, 0, 0, 0, 0, 0, 0, 0, 1 
1, 0, 0, 0, 0, 0, 0, 0, 1 
1, 1, 1, 1, 1, 1, 1, 1, 1 
";

        const string EmptyRoomGlobalSenseMap = @"
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.101,  0.780,  1.398,  1.938,  2.384,  2.720,  2.929,  3.000,  2.929,  2.720,  2.384
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.780,  1.515,  2.190,  2.789,  3.292,  3.675,  3.917,  4.000,  3.917,  3.675,  3.292
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.566,  1.398,  2.190,  2.929,  3.597,  4.169,  4.615,  4.901,  5.000,  4.901,  4.615,  4.169
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.151,  1.056,  1.938,  2.789,  3.597,  4.343,  5.000,  5.528,  5.877,  6.000,  5.877,  5.528,  5.000
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.513,  1.456,  2.384,  3.292,  4.169,  5.000,  5.757,  6.394,  6.838,  7.000,  6.838,  6.394,  5.757
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.528,  0.877,  1.000,  0.877,  0.528,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.780,  1.754,  2.720,  3.675,  4.615,  5.528,  6.394,  7.172,  7.764,  8.000,  7.764,  7.172,  6.394
   .   ,   .   ,   .   ,   .   ,   .   ,  0.757,  1.394,  1.838,  2.000,  1.838,  1.394,  0.757,   .   ,   .   ,   .   ,   .   ,   .   ,  0.945,  1.938,  2.929,  3.917,  4.901,  5.877,  6.838,  7.764,  8.586,  9.000,  8.586,  7.764,  6.838
   .   ,   .   ,   .   ,   .   ,  0.528,  1.394,  2.172,  2.764,  3.000,  2.764,  2.172,  1.394,  0.528,   .   ,   .   ,   .   ,   .   ,  1.000,  2.000,  3.000,  4.000,  5.000,  6.000,  7.000,  8.000,  9.000, 10.000,  9.000,  8.000,  7.000
   .   ,   .   ,   .   ,   .   ,  0.877,  1.838,  2.764,  3.586,  4.000,  3.586,  2.764,  1.838,  0.877,   .   ,   .   ,   .   ,   .   ,  0.945,  1.938,  2.929,  3.917,  4.901,  5.877,  6.838,  7.764,  8.586,  9.000,  8.586,  7.764,  6.838
   .   ,   .   ,   .   ,   .   ,  1.000,  2.000,  3.000,  4.000,  5.000,  4.000,  3.000,  2.000,  1.000,   .   ,   .   ,   .   ,   .   ,  0.780,  1.754,  2.720,  3.675,  4.615,  5.528,  6.394,  7.172,  7.764,  8.000,  7.764,  7.172,  6.394
   .   ,   .   ,   .   ,   .   ,  0.877,  1.838,  2.764,  3.586,  4.000,  3.586,  2.764,  1.838,  0.877,   .   ,   .   ,   .   ,   .   ,  0.513,  1.456,  2.384,  3.292,  4.169,  5.000,  5.757,  6.394,  6.838,  7.000,  6.838,  6.394,  5.757
   .   ,   .   ,   .   ,   .   ,  0.528,  1.394,  2.172,  2.764,  3.000,  2.764,  2.172,  1.394,  0.528,   .   ,   .   ,   .   ,   .   ,  0.151,  1.056,  1.938,  2.789,  3.597,  4.343,  5.000,  5.528,  5.877,  6.000,  5.877,  5.528,  5.000
   .   ,   .   ,   .   ,   .   ,   .   ,  0.757,  1.394,  1.838,  2.000,  1.838,  1.394,  0.757,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.566,  1.398,  2.190,  2.929,  3.597,  4.169,  4.615,  4.901,  5.000,  4.901,  4.615,  4.169
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.528,  0.877,  1.000,  0.877,  0.528,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.780,  1.515,  2.190,  2.789,  3.292,  3.675,  3.917,  4.000,  3.917,  3.675,  3.292
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.101,  0.780,  1.398,  1.938,  2.384,  2.720,  2.929,  3.000,  2.929,  2.720,  2.384
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.566,  1.056,  1.456,  1.754,  1.938,  2.000,  1.938,  1.754,  1.456
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.151,  0.513,  0.780,  0.945,  1.000,  0.945,  0.780,  0.513
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   
";

        const string EmptyRoomPerceptionStrength = @"
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.151,  1.056,  1.938,  2.789,  3.597,  4.343,  5.000,  5.528,  5.877,  6.000,  5.877,  5.528,  5.000
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.513,  1.456,  2.384,  3.292,  4.169,  5.000,  5.757,  6.394,  6.838,  7.000,  6.838,  6.394,  5.757
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.780,  1.754,  2.720,  3.675,  4.615,  5.528,  6.394,  7.172,  7.764,  8.000,  7.764,  7.172,  6.394
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.945,  1.938,  2.929,  3.917,  4.901,  5.877,  6.838,  7.764,  8.586,  9.000,  8.586,  7.764,  6.838
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  1.000,  2.000,  3.000,  4.000,  5.000,  6.000,  7.000,  8.000,  9.000, 10.000,  9.000,  8.000,  7.000
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.945,  1.938,  2.929,  3.917,  4.901,  5.877,  6.838,  7.764,  8.586,  9.000,  8.586,  7.764,  6.838
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.780,  1.754,  2.720,  3.675,  4.615,  5.528,  6.394,  7.172,  7.764,  8.000,  7.764,  7.172,  6.394
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.513,  1.456,  2.384,  3.292,  4.169,  5.000,  5.757,  6.394,  6.838,  7.000,  6.838,  6.394,  5.757
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.151,  1.056,  1.938,  2.789,  3.597,  4.343,  5.000,  5.528,  5.877,  6.000,  5.877,  5.528,  5.000
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.566,  1.398,  2.190,  2.929,  3.597,  4.169,  4.615,  4.901,  5.000,  4.901,  4.615,  4.169
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.780,  1.515,  2.190,  2.789,  3.292,  3.675,  3.917,  4.000,  3.917,  3.675,  3.292
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.101,  0.780,  1.398,  1.938,  2.384,  2.720,  2.929,  3.000,  2.929,  2.720,  2.384
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.566,  1.056,  1.456,  1.754,  1.938,  2.000,  1.938,  1.754,  1.456
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.151,  0.513,  0.780,  0.945,  1.000,  0.945,  0.780,  0.513
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   
";

        const string EmptyRoomSenseMapResult = @"
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.019,  0.218,  0.503,  0.842,  1.192,  1.504,  1.721,  1.800,  1.721,  1.504,  1.192
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.186,  0.499,  0.913,  1.394,  1.895,  2.350,  2.678,  2.800,  2.678,  2.350,  1.895
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.099,  0.380,  0.805,  1.352,  1.988,  2.666,  3.310,  3.805,  4.000,  3.805,  3.310,  2.666
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.014,  0.205,  0.568,  1.092,  1.763,  2.552,  3.419,  4.292,  5.046,  5.400,  5.046,  4.292,  3.419
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.051,  0.291,  0.715,  1.317,  2.085,  3.000,  4.030,  5.116,  6.154,  7.000,  6.154,  5.116,  4.030
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.074,  0.340,  0.797,  1.440,  2.262,  3.249,  4.372,  5.568,  6.666,  7.200,  6.666,  5.568,  4.372
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.074,  0.340,  0.797,  1.440,  2.262,  3.249,  4.372,  5.568,  6.666,  7.200,  6.666,  5.568,  4.372
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.051,  0.291,  0.715,  1.317,  2.085,  3.000,  4.030,  5.116,  6.154,  7.000,  6.154,  5.116,  4.030
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.014,  0.205,  0.568,  1.092,  1.763,  2.552,  3.419,  4.292,  5.046,  5.400,  5.046,  4.292,  3.419
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.099,  0.380,  0.805,  1.352,  1.988,  2.666,  3.310,  3.805,  4.000,  3.805,  3.310,  2.666
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.186,  0.499,  0.913,  1.394,  1.895,  2.350,  2.678,  2.800,  2.678,  2.350,  1.895
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.019,  0.218,  0.503,  0.842,  1.192,  1.504,  1.721,  1.800,  1.721,  1.504,  1.192
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.166,  0.380,  0.607,  0.809,  0.950,  1.000,  0.950,  0.809,  0.607
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,  0.042,  0.169,  0.287,  0.370,  0.400,  0.370,  0.287,  0.169
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   
   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .   ,   .";

        readonly HeatPhysicsConfiguration sourcePhysics;
        readonly InfraVisionSenseReceptorPhysicsConfiguration physics;

        public InfraVisionMapSystemTest()
        {
            this.sourcePhysics = new HeatPhysicsConfiguration(LinearDecaySensePhysics.For(DistanceCalculation.Chebyshev), Temperature.FromCelsius(0));
            this.physics = new InfraVisionSenseReceptorPhysicsConfiguration(sourcePhysics);
        }

        [Test]
        [TestCase(nameof(EmptyRoom), EmptyRoom, EmptyRoomGlobalSenseMap, EmptyRoomPerceptionStrength, EmptyRoomSenseMapResult)]
        public void Do(string id, string sourceText, string expectedGlobalSenseMap, string expectedResultText, string expectedSenseMapText)
        {
            base.PerformTest(id, sourceText, expectedGlobalSenseMap, expectedResultText, expectedSenseMapText);
        }

        protected override SensoryResistance Convert(float f)
        {
            return new SensoryResistance(Percentage.Empty, Percentage.Empty, Percentage.Of(f), Percentage.Empty);
        }

        protected override ReferenceItemDeclaration<SenseMappingTestContext, ItemReference> AttachTrait(ReferenceItemDeclaration<SenseMappingTestContext, ItemReference> decl)
        {
            switch (decl.Id.Id)
            {
                case "SenseReceptor-Active-10":
                    decl.WithTrait(new InfraVisionSenseTrait<SenseMappingTestContext, ItemReference>(physics, 10));
                    return decl;
                case "SenseReceptor-Active-5":
                    decl.WithTrait(new InfraVisionSenseTrait<SenseMappingTestContext, ItemReference>(physics, 5));
                    return decl;
                case "SenseReceptor-Inactive-5":
                    decl.WithTrait(new InfraVisionSenseTrait<SenseMappingTestContext, ItemReference>(physics, 5, false));
                    return decl;
                case "SenseSource-Active-10":
                    decl.WithTrait(new HeatSourceTrait<SenseMappingTestContext, ItemReference>(sourcePhysics, Temperature.FromCelsius(10)));
                    return decl;
                case "SenseSource-Active-5":
                    decl.WithTrait(new HeatSourceTrait<SenseMappingTestContext, ItemReference>(sourcePhysics, Temperature.FromCelsius(5)));
                    return decl;
                case "SenseSource-Inactive-5":
                    decl.WithTrait(new HeatSourceTrait<SenseMappingTestContext, ItemReference>(sourcePhysics));
                    return decl;
                default:
                    throw new ArgumentException();
            }
        }

        protected override SenseMappingSystemBase<VisionSense, TemperatureSense, HeatSourceDefinition> CreateSystem()
        {
            return new InfraVisionMapSystem(timeSource.AsLazy<ITimeSource>(),
                                            physics,
                                            new DefaultSenseDataBlitter()
            );
        }
    }
}